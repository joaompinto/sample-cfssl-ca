Sample Cloudflare SSL (CFSSL) Certificate Authority
---------------------------------------------------

This repository contains configuration files and command-line examples
for generating a Certificate Authority and Certificates using Cloudflare's
PKI and TLS toolkit, otherwise know as CFSSL, available at
[https://github.com/cloudflare/cfssl](https://github.com/cloudflare/cfssl) .

Based on[sample-cfssl-ca](https://github.com/drewfarris/sample-cfssl-ca)


Get the CFSSL binaries:
```sh
curl -Lo ~/.local/bin/cfssljson https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssljson_1.6.3_linux_amd64 
curl -Lo ~/.local/bin/cfssl https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssl_1.6.3_linux_amd64 
chmod 755 ~/.local/bin/cfssl*
```

Get the sample archives
```sh
curl -LO https://github.com/joaompinto/sample-cfssl-ca/archive/refs/heads/master.tar.gz
tar xvf master.tar.gz
cd sample-cfssl-ca-master
```


# Creating the Certificate Authority
```sh
cfssl gencert -initca ca-csr.json | cfssljson -bare ca
```

# Creating the Server Keypair
```sh
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=server \
  server-csr.json | cfssljson -bare server
```

### Creating the Client Keypair

```sh
cfssl gencert \
    -ca=ca.pem \
    -ca-key=ca-key.pem  \
    -config=ca-config.json \
    -profile=client \
    client-csr.json | cfssljson -bare client
```


### Creating PCKS12 Keystores

Creating the p12 from the key and cert:

```
openssl pkcs12 -export -out client.p12 \
  -inkey client-key.pem -in client.pem -certfile ca.pem
openssl pkcs12 -export -out server.p12 \
  -inkey server-key.pem -in server.pem -certfile ca.pem
```

### Creating JKS Keystore and Truststore

Java applications commonly need these:

Creating the jks from the p12:

```
keytool -importkeystore -srckeystore client.p12 \
  -storetype pkcs12 -destkeystore client.jks \
  -deststoretype jks

keytool -importkeystore -srckeystore server.p12 \
  -storetype pkcs12 -destkeystore server.jks \
  -deststoretype jks
```

#### Creating a truststore

```
keytool -import -file ca.pem -alias 'PrototypeCA' -keystore truststore.jks
```

### Creating a PCKS8 Keystore

This will generate an encrypted pkcs8 keystore, use `-nocrypt` if you don't want that.
```
openssl pkcs8 -topk8 -in server-key.pem -out server-key.p8
```

### Encrypting Private Keys

```
openssl rsa -aes256 -in server-key.pem -out server-key-enc.pem
```

If you need to remove encryption for some reason, e.g: to change the encryption key  or re-encrypt with
a different cipher, use:

```
openssl rsa -in server-key-enc.pem -out server-key.pem
```


### Creating SSH Keypairs from PKCS12 Keystores

SSH private keys are simply encrypted forms of the keys generated by CFSSL,
but you can generate the public version of this key using:

```
ssh-keygen -f client-key.pem -y > client.pub
```
